---
templateKey: blog-post
url: 20200616_keystore_delete
title: ReactNativeアプリでkeystoreファイルが消えた場合の対処法
date: 2020-06-16T10:07:22.613Z
description: |-
  ReactNativeのアプリは最終的にはAndroidかiOS(もしくはその両方)でのリリースを目指しています。
  しかし、リリースビルドというものは短いスパンでそう何回も繰り返すものではないため、久々にやってみると思いもよらないトラブルに遭遇しがちです。
  今回は、Androidのリリースビルド時にkeystoreファイルが消えてしまったトラブルを紹介します。
featuredpost: false
featuredimage: /img/react-native.jpg
tags:
  - react-native
  - Android
  - keystore
  - トラブル
  - Gitlab
  - git
  - .gitignore
---
## 前提条件
- `react-native`でアプリを開発
- `Android`でリリースビルドを1回でもしたことがある

## ある日のこと
仕事で開発している`ReactNative`アプリで、久しぶりに`Android`のリリースビルドを行うことになりました。
※しばらくは`iOS`向けに細々した機能のリリースを行っていた

手順自体は明文化されているため、特に問題らしい問題もなく、いよいよ最後の`keystore`ファイルによる署名作業に移ろうとしました。

```shell
apksigner sign --ks app/my-release-key.keystore --ks-key-alias my-key-alias my-app.apk
```

・・・とここで謎のエラーが発生。
よくよく内容を見ていくと`my-release-key.keystore`が無くなっている。

## Gitから取り直せばいいや
戸惑いつつも、ソース自体は`Gitlab`で管理しているから`keystore`を取り直せばいいか、と思い直す(なぜ`keystore`が消えたかは不明だが)。

しかし・・・

**あれ？`keystore`がGitになくない？**

## ここでちょっと解説(なぜ`keystore`が必要か)
`Google Play Store`に`APK`ファイルをアップロードする際には、`APK`ファイルに署名を行わなければなりません。
`Google`側はこの署名を確認して、アプリの開発元が正しいものである(=正規の`APK`ファイルである)と判定します。

そして、その署名に必要になってくるのが`keystore`ファイル(とその中にある`alias`)です。

署名は`APK`ファイルのビルド時に行い、そこで`keystore`ファイル、`alias`、`alias`のパスワードを使います。

今回は`keystore`ファイルが何らかの原因で消失してしまったわけです。

`Google`は`Google Play App Signing`という署名方法を推奨しており、今回はこの方式を採用していたのでなんとかなった、という話です。
他の方式の場合は、そもそも`keystore`を紛失したら対応不可！なんて記事も見かけます(真偽は不明ですが・・・)

## なぜ`keystore`は消えた？

こればかりは今今の時点で原因不明です。
先述の通り、ソースコードは`Gitlab`で管理しているのですが、`keystore`は`.gitignore`に含まれていたため、Git管理をしていませんでした。
それ自体は決して悪いことではなく(アプリリリースに関する`keystore`を考えもなしにGitの管理下に置くのはそれはそれでリスクがある)、ファイルサーバ等に置いて管理しているケースもあるようです。
いずれにせよ、今回は自端末(それも開発機として頻繁にソースをいじる)にしかリリース用の`keystore`を置いておらず、管理をしていないことが原因でした。

※ちなみに、この反省を受けて現在は`Gitlab`で管理しています。プロジェクトに関わるメンバなら見れてしまいますが、担当しか`alias`のパスワードが分からないので大丈夫、という認識です。
もっと良い管理方法をご存じの方がいらっしゃいましたらコメントにてお教えください。

## 復旧手順
ざっくり説明すると、新規に`keystore`ファイルを作成し、`pem`ファイルを作成。
作成した`pem`ファイルを`Google Play Console`からアップロードしてアップロード用鍵のリセットを申請した。ということです。

### keystoreを再生成
下記のコマンドを入力し、いくつかの質問に答えると`keystore`ファイルが生成されます。最後にパスワードを聞かれるので登録する。

```shell
keytool -genkey -v -keystore my-release-key.keystore -alias my-key-alias -keyalg RSA -keysize 2048 -validity 10000
```

### pemファイルを生成
下記のコマンドを入力し、`keystore`生成時のパスワードを入力すると、`pem`ファイルが生成されます。

```shell
keytool -export -rfc -alias my-key-alias -file my-release-key.pem -keystore my-release-key.keystore
```

### なぜpemファイルを生成するのか
これは先にちらっと出てきた`Google Play App Signing`に関連しています。
`Google Play App Signing`をざっくり説明すると、`Google`に対して`リリース用鍵`を渡し、`APK`ファイルをビルドする際は`アップロード用鍵`で署名する方式です。
この方式のポイントは、`リリース用鍵`を管理しなくともよく、リリースする側(`APK`をアップロードする側)は`アップロード用鍵`だけを管理すればよいということです。
`アップロード用鍵`は再登録できる(とはいても簡単にはできない)ので紛失しても安心、というわけです。
つまり、ここで生成した`pem`ファイルは新たな`リリース用鍵`で、`keystore`は`アップロード用鍵`です。

## Googleにpemをアップロード
`Google Play Console`で対象アプリを開いたら**[リリース管理]**→**[アプリの署名]**を開き、**[鍵のアップグレードをリクエスト]**をクリック。

事由を聞かれるので、
**[各リリースの署名に使用しているアップロード鍵を紛失したため]**を選択し**[次へ]**を押下

![keystore2](/img/keystore2.png "keystore2")

サポートに問い合わせてほしい旨のメッセージが表示されるので、**[サポートにお問合せ]**を押下。

問い合わせ画面が表示されるので、各種アプリ情報を入力して**[鍵またはキーストアに関連する問題がある]**を選択。
続いて**[アップロード鍵を忘れた]**を選択し、詳細を記入(下図参照)。
最後に`pem`ファイルを添付して**[送信]**を実行。

![keystore1](/img/keystore1.png "keystore1")

数日経つと`Google`から登録していたアドレス宛にメールが届きます。
内容をかみ砕くと、

- 新しい鍵の登録が完了したで
- YYYY-mm-ddから利用可能や
- 今度からは気を付けるんやで(意訳)

といった旨です。
実際に指定された日時以降は、新しい`keystore`ファイルで署名をした`APK`ファイルがリリースできるようになりました！

## まとめと反省  
反省点としては、`keystore`の管理方法が杜撰だったの一言に尽きます。
これは何も`keystore`だからという話に限らず、アプリやプロジェクトのコアとなる`大事そうなファイル`は**バックアップを取る**、**バージョン管理をする**などが重要です(初歩中の初歩ですが、今回は実際それができていなかった)。

なんにせよ`react-native`のプロジェクトでは、デフォルトの`.gitignore`に`.keystore`を含めてあめ、今回と同じ事象に遭遇する方は少なからずいると思います。
その場合の一助になれば幸いです。